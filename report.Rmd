---
title: "Analysis Report"
author: "Ben Lorentz"
output:
  html_document:
    df_print: paged
---
```{r install/load libraries, include=FALSE}
if(!require(kableExtra)) {install.packages("kableExtra", repos="http://cran.us.r-project.org")}
if(!require(ggplot2)) {install.packages("ggplot2", repos="http://cran.us.r-project.org")}
if(!require(tidyverse)) {install.packages("tidyverse", repos="http://cran.us.r-project.org")}
if(!require(gplots)) {install.packages("gplots", repos="http://cran.us.r-project.org")}
if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
if(!require(qiime2R)) {devtools::install_github("jbisanz/qiime2R")} # current version is 0.99.20
if(!require(phyloseq)) {install.packages("phyloseq")}
if(!require(gtools)) {install.packages("gtools")}
if(!require(reshape2)) {install.packages("reshape2")}
if(!require(forcats)) {install.packages("forcats")}
if(!require(gridExtra)) {install.packages("gridExtra")}
if(!requireNamespace("BiocManager")){install.packages("BiocManager")}
if(!require(microbiome)){BiocManager::install("microbiome")}
if(!require(NMF)){install.packages("NMF")}
if(!require(pheatmap)){install.packages("pheatmap")}
library(gtools)
library(kableExtra)
library(ggplot2)
library(qiime2R)
library(phyloseq)
library(reshape2)
library(forcats)
library(gridExtra)
library(microbiome)
library(NMF)
library(pheatmap)

```
This is a report generated to summarize the major results from the analysis. It is not intended to be a full picture, rather a jumping off point. This report will reference the files displayed in case you would like to examine them further.


```{r parse item of interest and make outdir for figures, include=FALSE}
#item of interest, comes from bash and python script that orchestrates everything
ioi <- read.csv("item_of_interest.csv")
ioi<-as.character(ioi)

outdir_name <- "Figures"
if(!dir.exists(paste0("./",outdir_name))) {dir.create(paste0("./",outdir_name))}
outdir <- paste0("./",outdir_name)


```

## Species Distribution

### Relative Abundance of Top 10 Phyal

```{r stacked bar chart at Phylum level, message=FALSE, warning=FALSE, echo=FALSE}
level = "Phylum"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at phylum level to plot
topN <- 10

#selects top n taxa and creates phyloseq object
cycle_n_names <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [1:topN]
cycle_n <- subset_taxa(cycle_1, get(level) %in% names(cycle_n_names))
cycle_n_glom <- tax_glom(cycle_n, taxrank = level)

#selects top n + 1 to the end of table
rest_tax <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [topN+1:length(tax_table(cycle_1))]
rest <- subset_taxa(cycle_1, get(level) %in% names(rest_tax))
rest_glom <- tax_glom(rest, taxrank = level)

#collapse all phyla not in top 10 into one taxon
rest_merge <- merge_taxa(rest, taxa_names(rest))

#create dummy taxonomy classification for collapsed taxa
taxvec <- c("Other","Other","Other","Other","Other", "Other","Other")
taxlist <- list(OTU1=parse_taxonomy_default(taxvec))
tax_tab <- build_tax_table(taxlist)
colnames(tax_tab) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(tax_tab) <- rownames(tax_table(rest_merge))
tax_table(rest_merge) <- tax_tab

#attaches top n phyloseq object with the other phyloseq object
merge_tax <- merge_phyloseq(tax_table(cycle_n), tax_table(rest_merge))
merge_otu <- merge_phyloseq(otu_table(cycle_n), otu_table(rest_merge))
merge_samp <- merge_phyloseq(sample_data(cycle_n), sample_data(rest_merge))

merged <- merge_phyloseq(merge_tax, merge_otu, merge_samp)

#calculates relative abundance based on sample provided and turns that into a dataframe for ggplot2 plotting
cycle_1_phylum <- merged %>%
  tax_glom(taxrank = level) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)


#ggplot2 stacked bar chart separated by sample in the metadata from qiime2
by_sample <- ggplot(cycle_1_phylum, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cycle_1_phylum[[level]], Abundance),"Other"))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title=level))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,vjust=0.5, hjust=1)) 

#calculates relative abundance based on item of interest provided in original bash script
cy_phylum <- merged %>%
  tax_glom(taxrank = level) %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot2 stacked bar chart separated by item of interet in the metadata from qiime2 identified by user
by_treatment <- ggplot(cy_phylum, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cy_phylum[[level]],Abundance),"Other"))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title=level)) + 
  xlab(label = ioi) +
  theme_minimal()


#prints charts to rnotebook
print(by_sample)
print(by_treatment)

#saves charts to directory
ggsave("stacked_bar_phylum_by_sample.png", plot=by_sample, path=outdir)
ggsave("stacked_bar_phylum_by_treatment.png", plot=by_treatment, path=outdir)

```

### Relative Abundance of Top 10 Genera

```{r stacked bar chart at Genus level, message=FALSE, warning=FALSE, echo=FALSE}
level = "Genus"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at genus level to plot
topN <- 10

#selects top n taxa and creates phyloseq object
cycle_n_names <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [1:topN]
cycle_n <- subset_taxa(cycle_1, get(level) %in% names(cycle_n_names))
cycle_n_glom <- tax_glom(cycle_n, taxrank = level)

#selects top n + 1 to the end of table
rest_tax <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [topN+1:length(tax_table(cycle_1))]
rest <- subset_taxa(cycle_1, get(level) %in% names(rest_tax))
rest_glom <- tax_glom(rest, taxrank = level)

#collapse all genera not in top 10 into one taxon
rest_merge <- merge_taxa(rest, taxa_names(rest))

#create dummy taxonomy classificaiton for collapsed taxa
taxvec <- c("Other","Other","Other","Other","Other", "Other","Other")
taxlist <- list(OTU1=parse_taxonomy_default(taxvec))
tax_tab <- build_tax_table(taxlist)
colnames(tax_tab) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(tax_tab) <- rownames(tax_table(rest_merge))
tax_table(rest_merge) <- tax_tab

#attaches top n phyloseq object with the other phyloseq object
merge_tax <- merge_phyloseq(tax_table(cycle_n), tax_table(rest_merge))
merge_otu <- merge_phyloseq(otu_table(cycle_n), otu_table(rest_merge))
merge_samp <- merge_phyloseq(sample_data(cycle_n), sample_data(rest_merge))

merged <- merge_phyloseq(merge_tax, merge_otu, merge_samp)

#calculate relative abundance based on sample
cycle_1_genus <- merged %>%
  tax_glom(taxrank = level) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot of stacked bar chart separated by sample
by_sample <- ggplot(cycle_1_genus, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cycle_1_genus[[level]], Abundance),"Other"))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title=level))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,vjust=0.5, hjust=1)) 

#calculate relative abundance based on treatment 
cy_genus <- merged %>%
  tax_glom(taxrank = level) %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot figure of stacked bar chart separated by treatment
by_treatment <- ggplot(cy_genus, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cy_genus[[level]],Abundance),"Other"))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title=level)) + 
  xlab(label = ioi) +
  theme_minimal()

#prints charts for rnotebook
print(by_sample)
print(by_treatment)

#saves copies of figures to outdir
ggsave("stacked_bar_genus_by_sample.png", plot=by_sample, path = outdir)
ggsave("stacked_bar_genus_by_treatment.png", plot = by_treatment, path=outdir)

```

### Relative Abundance of Top 10 Species

```{r stacked bar chart at Species level, message=FALSE, warning=FALSE, echo=FALSE}
level = "Species"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at species level to plot
topN <- 10

#selects top n taxa and creates phyloseq object
cycle_n_names <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [1:topN]
cycle_n <- subset_taxa(cycle_1, get(level) %in% names(cycle_n_names))
cycle_n_glom <- tax_glom(cycle_n, taxrank = level)

#selects top n + 1 to the end of table
rest_tax <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [topN+1:length(tax_table(cycle_1))]
rest <- subset_taxa(cycle_1, get(level) %in% names(rest_tax))
rest_glom <- tax_glom(rest, taxrank = level)

#collapse all species not in top 10 into one taxon
rest_merge <- merge_taxa(rest, taxa_names(rest))

#create dummy taxonomy classificaiton for collapsed taxa
taxvec <- c("Other","Other","Other","Other","Other", "Other","Other")
taxlist <- list(OTU1=parse_taxonomy_default(taxvec))
tax_tab <- build_tax_table(taxlist)
colnames(tax_tab) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(tax_tab) <- rownames(tax_table(rest_merge))
tax_table(rest_merge) <- tax_tab

#attaches top n phyloseq object with the other phyloseq object
merge_tax <- merge_phyloseq(tax_table(cycle_n), tax_table(rest_merge))
merge_otu <- merge_phyloseq(otu_table(cycle_n), otu_table(rest_merge))
merge_samp <- merge_phyloseq(sample_data(cycle_n), sample_data(rest_merge))

merged <- merge_phyloseq(merge_tax, merge_otu, merge_samp)

#calculates relative abundance based on sample
cycle_1_species <- merged %>%
  tax_glom(taxrank = level) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot stacked bar chart separated by species
by_sample <- ggplot(cycle_1_species, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cycle_1_species[[level]], Abundance),"Other"))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title=level))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,vjust=0.5, hjust=1)) 


#calculates relative abundance based on treatment
cy_species <- merged %>%
  tax_glom(taxrank = level) %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot stacked bar chart separated by treatment
by_treatment <- ggplot(cy_species, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cy_species[[level]],Abundance),"Other"))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title=level)) + 
  xlab(label = ioi) +
  theme_minimal()

#prints figures to rnotebook
print(by_sample)
print(by_treatment)

#saves copies of figures to directory
ggsave("stacked_bar_species_by_sample.png", plot=by_sample, path=outdir)
ggsave("stacked_bar_species_by_treatment.png", plot=by_treatment, path=outdir)

```

## Species Abundance Heatmap

```{r heatmap at the Genus level annotatted with item of interest, echo=FALSE, warning=FALSE, message=FALSE}

level = "Genus"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at species level to plot
topN <- 35

# z transform whole dataset
cycle_z <- microbiome::transform(cycle_1, "Z")

#subsets top n items at phylo rank
cycle_z_names <- sort(tapply(taxa_sums(cycle_z), tax_table(cycle_z)[,as.character(level)], sum), TRUE) [1:topN]
cycle_z_taxa <- subset_taxa(cycle_1, get(level) %in% names(cycle_z_names))

#selects and removes top n item at phylo rank, (without previous step would take ASV/OTUs and there would be overlap)
cycle_z_prune_names <- sort(taxa_sums(tax_glom(cycle_z_taxa, taxrank = level)), TRUE)[1:topN]
cycle_z_prune <- prune_taxa(names(cycle_z_prune_names), cycle_1)

#plots heatmap with annotations for item of interest
heatmap <- pheatmap::pheatmap(otu_table(cycle_z_prune), labels_row=tax_table(cycle_z_prune)[,"Genus"], annotation_row = data.frame(tax_table(cycle_z_prune)[,"Phylum"]), annotation_col = data.frame(sample_data(cycle_z_prune)[,ioi]), width = 10, height = 10, fontsize = 14, scale = "column")

#saves a copy of the heatmap to outdir
ggsave("heatmap.png", plot=heatmap, width = 20, height = 10, units = "in", path=outdir )


```


```{r read in cutoffs used by qiime, include=FALSE}
cutoffs = read.csv("cutoffs.csv",sep = ',',strip.white = TRUE)
#cutoffs = knitr::kable(cutoffs)
cutoffs %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```


```{r make data table for dada2 stats from qiime, include=FALSE}
dadastat = read.csv("dada2_stats.tsv",sep = '\t',strip.white = TRUE)
#dadastat_t = dadastat %>% kbl() %>% kable_classic(full_width = F)
dadastat %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive")) 
```

```{r table for sampling depth in qiime, include=FALSE}
depth = read.csv("sampling_depth.csv", sep=",")
depth %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```


```{r table for evenness measurement of alpha div,include=FALSE}
evenness_vals = read.csv("./evenness/metadata.tsv", sep='\t')
evenness_vals %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```

```{r stats for evenness measurement of alpha div, include=FALSE}

filename = paste("./evenness/kruskal-wallis-pairwise-",str_trim(ioi),".csv", sep = "")
evenness_stats = read.csv(filename)

evenness_stats %>% kbl() %>% kable_styling(bootstrap_options = c("condensed","responsive"))
```


```{r table for faith measurement of alpha div, include=FALSE}
faith_vals = read.csv("./faith/metadata.tsv", sep='\t')
faith_vals %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```

```{r stats for faith measurement of alpha div, include=FALSE}
filename <- paste("./faith/kruskal-wallis-pairwise-",ioi,".csv",sep="")
faith_stats = read.csv(filename)
faith_stats %>% kbl() %>% kable_styling(bootstrap_options = c("condensed","responsive"))
```


```{r table of shannon alpha diversity, include=FALSE}
library(qiime2R)
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon$data
```

```{r table of observed species measurement of richness alpha div, include=FALSE}
library(qiime2R)
obs<-read_qza("core-metrics-results/observed_features_vector.qza")
obs$data
```

## Alpha Diversity Plot 

### Evenness 

```{r alpha diversity plot of eveness, echo=FALSE, message=FALSE, warning=FALSE}
#subsets and plots evenness values in a boxplot format
ioi <- read.csv("item_of_interest.csv")
ioi<-as.character(ioi)
evenness_vals = read.csv("./evenness/metadata.tsv", sep='\t')
dims = dim(evenness_vals)
evenness_vals <- data.frame(evenness_vals[2:dims[1],])
evenness_vals[[ioi]] <- reorder(as.factor(evenness_vals[[ioi]]))
evenness_vals$pielou_evenness <- as.numeric(as.character(evenness_vals$pielou_evenness))
evenness_boxplot <- ggplot(evenness_vals, aes_string(x=ioi,y = evenness_vals$pielou_evenness)) + geom_boxplot() + ylab("Evenness") +theme_bw()
evenness_boxplot 

ggsave("evenness_boxplot.png", plot=evenness_boxplot, path=outdir)

#plots evenness values in a violin plot format 
p <- ggplot(evenness_vals, aes(x=evenness_vals[[ioi]], y=pielou_evenness)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Evenness") + theme_bw()
p

ggsave("evenness_violin_plot.png", plot=p, path=outdir)
```

### Faith

```{r alpha diversity plot of faith, echo=FALSE,message=FALSE, warning=FALSE}
dims = dim(faith_vals)
faith_vals <- data.frame(faith_vals[2:dims[1],])
faith_vals[[ioi]] <- reorder(as.factor(faith_vals[[ioi]]))
faith_vals$faith_pd <- as.numeric(as.character(faith_vals$faith_pd))
faith_boxplot <- ggplot(faith_vals, aes(x=faith_vals[[ioi]], y=faith_vals$faith_pd)) + geom_boxplot() + ylab("Faith") + theme_bw() + xlab(ioi)
faith_boxplot

ggsave("faith_boxplot.png", plot=faith_boxplot, path=outdir)

p <- ggplot(faith_vals, aes(x=faith_vals[[ioi]], y=faith_pd)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Faith") + theme_bw()
p

ggsave("faith_violin_plot.png", plot=p, path=outdir)
```

## Beta diversity 

### Bray curtis ordination

```{r beta diversity plot of bray curtis measurement, echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
bray_pcoa <- read_qza("core-metrics-results/bray_curtis_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


bray_curtis <- bray_pcoa$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

bray_curtis
ggsave("bray_curtis_pcoa_ordination.png", plot=bray_curtis, path=outdir)

```

### Jaccard ordination

```{r pcoa using Jaccard distance, echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
jaccard <- read_qza("core-metrics-results/jaccard_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")

metadata[[ioi]] <- reorder(metadata[[ioi]])

jaccard_pcoa <- jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

jaccard_pcoa

ggsave("jaccard_pcoa_ordination.png", plot=jaccard_pcoa, path=outdir)
```

### unweighted unifrac ordination

```{r unweighted unifrac pcoa ordination, echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/unweighted_unifrac_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


unweight_unifrac_pcoa <- jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

unweight_unifrac_pcoa 

ggsave("unweighted_unifrac_pcoa_ordination.png", plot=unweight_unifrac_pcoa, path=outdir)

```

### weighted unifrac ordination

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/weighted_unifrac_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


weighted_unifrac_pcoa <- jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

weighted_unifrac_pcoa

ggsave("weighted_unifrac_pcoa_ordination.png", plot=weighted_unifrac_pcoa, path=outdir)

```

