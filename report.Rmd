---
title: "Analysis Report"
output:
  html_document:
    df_print: paged
---
<!-- This is sometimes nessecary, it will manifest with a unable to load shared object '/usr/local/lib/R/ error -->
<!-- you can run ldconfig -p|grep $BROKEN_PACKAGE -->
<!-- then you take the stem of where the bin for that package is and replace it below -->
```{r handle lib errors, echo=FALSE, message=FALSE, warning=FALSE}
Sys.setenv(LD_LIBRARY_PATH = "/lib64")
Sys.setenv(PKG_CONFIG_PATH = "/lib64/pkgconfig")
```

```{r install/load libraries, echo=FALSE, message=FALSE, warning=FALSE}
if(!require(kableExtra)) {install.packages("kableExtra", repos="http://cran.us.r-project.org")}
if(!require(remotes)){install.packages("remotes")}
if(!require(ggplot2)) {remotes::install_github("tidyverse/ggplot2@v3.3.2")}
if(!require(tidyverse)) {install.packages("tidyverse", repos="http://cran.us.r-project.org")}
if(!require(gplots)) {install.packages("gplots", repos="http://cran.us.r-project.org")}
if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
if(!require(qiime2R)) {devtools::install_github("jbisanz/qiime2R")} # current version is 0.99.20
if(!require(phyloseq)) {install.packages("phyloseq")}
if(!require(gtools)) {install.packages("gtools")}
if(!require(reshape2)) {install.packages("reshape2")}
if(!require(forcats)) {install.packages("forcats")}
if(!require(gridExtra)) {install.packages("gridExtra")}
if(!requireNamespace("BiocManager")){install.packages("BiocManager")}
if(!require(microbiome)){BiocManager::install("microbiome")}
if(!require(NMF)){install.packages("NMF")}
if(!require(pheatmap)){install.packages("pheatmap")}
if(!require(rstatix)){installl.packages("rstatix")}
# if(!require(knitr)){install.packages("knitr")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(reshape2)){install.packages("reshape2")}
if(!require(ampvis2)){remotes::install_github("MadsAlbertsen/ampvis2")}
if(!require(devtools)) {install.packages("devtools")}
library(remotes)
library(openssl)
library(gtools)
library(kableExtra)
library(qiime2R)
library(phyloseq)
library(reshape2)
library(forcats)
library(gridExtra)
#library(microbiome)
library(NMF)
library(pheatmap)
library(rstatix)
library(knitr)
#library(tidyverse)
library(reshape2)
library(ampvis2)


```
<!-- input files required:  -->
<!-- item_of_interest.csv -->
<!-- table-dada2.qza -->
<!-- rooted-tree.qza -->
<!-- taxonomy.qza -->
<!-- metadata.tsv -->
<!-- image_.*_graph.png[any number of files that match that pattern for phylo trees] -->
<!-- *cutoffs.csv -->
<!-- *dada2_stats.tsv -->
<!-- *sampling_depth.csv -->
<!-- obs/metadata.tsv -->
<!-- shannon/metadata.tsv -->
<!-- simpson/metadata.tsv -->
<!-- chao1/metadata.tsv -->
<!-- ace/metadata.tsv -->
<!-- faith_pd/metadata.tsv -->
<!-- core-metrics-results/bray_curtis_pcoa_results.qza -->
<!-- core-metrics-results/shannon_vector.qza -->
<!-- core-metrics-results/jaccard_pcoa_results.qza -->
<!-- core-metrics-results/unweighted_unifrac_pcoa_results.qza -->
<!-- core-metrics-results/weighted_unifrac_pcoa_results.qza -->
<!-- alpha-rare/observed_otus.csv -->




This is a report generated to summarize the major results from the analysis. It is not intended to be a full picture, rather a jumping off point. This report will reference the files displayed in case you would like to examine them further.


```{r parse item of interest and make outdir for figures, echo=FALSE, message=FALSE, warning=FALSE}
#item of interest, comes from bash and python script that orchestrates everything
ioi <- read.csv("item_of_interest.csv")
ioi<-as.character(ioi)

outdir_name <- "Figures"
if(!dir.exists(paste0("./",outdir_name))) {dir.create(paste0("./",outdir_name))}
outdir <- paste0("./",outdir_name)


```

## Species Distribution

### Relative Abundance of Top 10 Phyla

```{r stacked bar chart at Phylum level, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}
options(bitmapType='cairo')
level = "Phylum"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at phylum level to plot
topN <- 10

#selects top n taxa and creates phyloseq object
cycle_n_names <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [1:topN]
cycle_n <- subset_taxa(cycle_1, get(level) %in% names(cycle_n_names))
cycle_n_glom <- tax_glom(cycle_n, taxrank = level)

#selects top n + 1 to the end of table
rest_tax <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [topN+1:length(tax_table(cycle_1))]
rest <- subset_taxa(cycle_1, get(level) %in% names(rest_tax))
rest_glom <- tax_glom(rest, taxrank = level)

#collapse all phyla not in top 10 into one taxon
rest_merge <- merge_taxa(rest, taxa_names(rest))

#create dummy taxonomy classification for collapsed taxa
taxvec <- c("Other","Other","Other","Other","Other", "Other","Other")
taxlist <- list(OTU1=parse_taxonomy_default(taxvec))
tax_tab <- build_tax_table(taxlist)
colnames(tax_tab) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(tax_tab) <- rownames(tax_table(rest_merge))
tax_table(rest_merge) <- tax_tab

#attaches top n phyloseq object with the other phyloseq object
merge_tax <- merge_phyloseq(tax_table(cycle_n), tax_table(rest_merge))
merge_otu <- merge_phyloseq(otu_table(cycle_n), otu_table(rest_merge))
merge_samp <- merge_phyloseq(sample_data(cycle_n), sample_data(rest_merge))

merged <- merge_phyloseq(merge_tax, merge_otu, merge_samp)

#calculates relative abundance based on sample provided and turns that into a dataframe for ggplot2 plotting
cycle_1_phylum <- merged %>%
  tax_glom(taxrank = level) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)


#ggplot2 stacked bar chart separated by sample in the metadata from qiime2
by_sample <- ggplot(cycle_1_phylum, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cycle_1_phylum[[level]], Abundance),"Other"))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title=level))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,vjust=0.5, hjust=1))+
  theme(text=element_text(size = 20))

print(by_sample)
ggsave("stacked_bar_phylum_by_sample.png", plot=by_sample, path=outdir)

#calculates relative abundance based on item of interest provided in original bash script
cy_phylum <- merged %>%
  tax_glom(taxrank = level) %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

cy_phylum$Sample <- reorder(as.factor(cy_phylum$Sample))

#ggplot2 stacked bar chart separated by item of interet in the metadata from qiime2 identified by user
by_treatment <- ggplot(cy_phylum, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cy_phylum[[level]],Abundance),"Other"))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title=level)) + 
  xlab(label = ioi) +
  theme_minimal()+
  theme(text=element_text(size = 20))


#prints charts to rnotebook

print(by_treatment)

#saves charts to directory

ggsave("stacked_bar_phylum_by_treatment.png", plot=by_treatment, path=outdir)

```

### Relative Abundance of Top 10 Genera

```{r stacked bar chart at Genus level, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}
level = "Genus"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at genus level to plot
topN <- 10

#selects top n taxa and creates phyloseq object
cycle_n_names <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [1:topN]
cycle_n <- subset_taxa(cycle_1, get(level) %in% names(cycle_n_names))
cycle_n_glom <- tax_glom(cycle_n, taxrank = level)

#selects top n + 1 to the end of table
rest_tax <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [topN+1:length(tax_table(cycle_1))]
rest <- subset_taxa(cycle_1, get(level) %in% names(rest_tax))
rest_glom <- tax_glom(rest, taxrank = level)

#collapse all genera not in top 10 into one taxon
rest_merge <- merge_taxa(rest, taxa_names(rest))

#create dummy taxonomy classificaiton for collapsed taxa
taxvec <- c("Other","Other","Other","Other","Other", "Other","Other")
taxlist <- list(OTU1=parse_taxonomy_default(taxvec))
tax_tab <- build_tax_table(taxlist)
colnames(tax_tab) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(tax_tab) <- rownames(tax_table(rest_merge))
tax_table(rest_merge) <- tax_tab

#attaches top n phyloseq object with the other phyloseq object
merge_tax <- merge_phyloseq(tax_table(cycle_n), tax_table(rest_merge))
merge_otu <- merge_phyloseq(otu_table(cycle_n), otu_table(rest_merge))
merge_samp <- merge_phyloseq(sample_data(cycle_n), sample_data(rest_merge))

merged <- merge_phyloseq(merge_tax, merge_otu, merge_samp)

#calculate relative abundance based on sample
cycle_1_genus <- merged %>%
  tax_glom(taxrank = level) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot of stacked bar chart separated by sample
by_sample <- ggplot(cycle_1_genus, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cycle_1_genus[[level]], Abundance),"Other"))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title=level))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,vjust=0.5, hjust=1)) +
  theme(text=element_text(size = 20))

print(by_sample)
ggsave("stacked_bar_genus_by_sample.png", plot=by_sample, path=outdir)

#calculate relative abundance based on treatment 
cy_genus <- merged %>%
  tax_glom(taxrank = level) %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

cy_genus$Sample <- reorder(as.factor(cy_genus$Sample))

#ggplot figure of stacked bar chart separated by treatment
by_treatment <- ggplot(cy_genus, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cy_genus[[level]],Abundance),"Other"))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title=level)) + 
  xlab(label = ioi) +
  theme_minimal()+
  theme(text=element_text(size = 20))

#prints charts for rnotebook

print(by_treatment)

#saves copies of figures to outdir

ggsave("stacked_bar_genus_by_treatment.png", plot = by_treatment, path=outdir)

```

### Relative Abundance of Top 10 Species

```{r stacked bar chart at Species level, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}
level = "Species"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at species level to plot
topN <- 10

#selects top n taxa and creates phyloseq object
cycle_n_names <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [1:topN]
cycle_n <- subset_taxa(cycle_1, get(level) %in% names(cycle_n_names))
cycle_n_glom <- tax_glom(cycle_n, taxrank = level)

#selects top n + 1 to the end of table
rest_tax <- sort(tapply(taxa_sums(cycle_1), tax_table(cycle_1)[,as.character(level)], sum), TRUE) [topN+1:length(tax_table(cycle_1))]
rest <- subset_taxa(cycle_1, get(level) %in% names(rest_tax))
rest_glom <- tax_glom(rest, taxrank = level)

#collapse all species not in top 10 into one taxon
rest_merge <- merge_taxa(rest, taxa_names(rest))

#create dummy taxonomy classificaiton for collapsed taxa
taxvec <- c("Other","Other","Other","Other","Other", "Other","Other")
taxlist <- list(OTU1=parse_taxonomy_default(taxvec))
tax_tab <- build_tax_table(taxlist)
colnames(tax_tab) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
rownames(tax_tab) <- rownames(tax_table(rest_merge))
tax_table(rest_merge) <- tax_tab

#attaches top n phyloseq object with the other phyloseq object
merge_tax <- merge_phyloseq(tax_table(cycle_n), tax_table(rest_merge))
merge_otu <- merge_phyloseq(otu_table(cycle_n), otu_table(rest_merge))
merge_samp <- merge_phyloseq(sample_data(cycle_n), sample_data(rest_merge))

merged <- merge_phyloseq(merge_tax, merge_otu, merge_samp)

#calculates relative abundance based on sample
cycle_1_species <- merged %>%
  tax_glom(taxrank = level) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

#ggplot stacked bar chart separated by species
by_sample <- ggplot(cycle_1_species, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cycle_1_species[[level]], Abundance),"Other"))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title=level))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90,vjust=0.5, hjust=1)) +
  theme(text=element_text(size = 20))

print(by_sample)
ggsave("stacked_bar_species_by_sample.png", plot=by_sample, path=outdir)


#calculates relative abundance based on treatment
cy_species <- merged %>%
  tax_glom(taxrank = level) %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  arrange(Abundance)

cy_species$Sample <- reorder(as.factor(cy_species$Sample))

#ggplot stacked bar chart separated by treatment
by_treatment <- ggplot(cy_species, aes(x=Sample, y=Abundance, fill=fct_relevel(fct_reorder(cy_species[[level]],Abundance),"Other"))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title=level)) + 
  xlab(label = ioi) +
  theme_minimal()+
  theme(text=element_text(size = 20))

#prints figures to rnotebook

print(by_treatment)

#saves copies of figures to directory

ggsave("stacked_bar_species_by_treatment.png", plot=by_treatment, path=outdir)

```

## Phylogentic Trees

```{r phylo-tree", echo=FALSE, message=FALSE, warning=FALSE}

tree_filenames <- list.files(pattern="image_.*_graph.png")

include_graphics(tree_filenames)


```

## Species Abundance Heatmap

```{r heatmap at the Genus level annotatted with item of interest, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}

level = "Genus"

#Create phyloseq object from qiime objects
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

#Select number of taxa at species level to plot
topN <- 35

# z transform whole dataset
cycle_z <- microbiome::transform(cycle_1, "Z")

#subsets top n items at phylo rank
cycle_z_names <- sort(tapply(taxa_sums(cycle_z), tax_table(cycle_z)[,as.character(level)], sum), TRUE) [1:topN]
cycle_z_taxa <- subset_taxa(cycle_1, get(level) %in% names(cycle_z_names))

#selects and removes top n item at phylo rank, (without previous step would take ASV/OTUs and there would be overlap)
cycle_z_prune_names <- sort(taxa_sums(tax_glom(cycle_z_taxa, taxrank = level)), TRUE)[1:topN]
cycle_z_prune <- prune_taxa(names(cycle_z_prune_names), cycle_1)

cycle_z_prune@sam_data[[ioi]] <- reorder(cycle_z_prune@sam_data[[ioi]])


#plots heatmap with annotations for item of interest
heatmap <- pheatmap::pheatmap(otu_table(cycle_z_prune), labels_row=tax_table(cycle_z_prune)[,"Genus"], annotation_row = data.frame(tax_table(cycle_z_prune)[,"Phylum"]), annotation_col = data.frame(sample_data(cycle_z_prune)[,ioi]), width = 10, height = 10, fontsize = 14, scale = "column")

#saves a copy of the heatmap to outdir
ggsave("heatmap.png", plot=heatmap, path=outdir)



```


```{r read in cutoffs used by qiime, message=FALSE, warning=FALSE, include=FALSE}
cutoffs = read.csv("cutoffs.csv",sep = ',',strip.white = TRUE)
#cutoffs = knitr::kable(cutoffs)
cutoffs %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```


```{r make data table for dada2 stats from qiime, message=FALSE, warning=FALSE, include=FALSE}
dadastat = read.csv("dada2_stats.tsv",sep = '\t',strip.white = TRUE)
#dadastat_t = dadastat %>% kbl() %>% kable_classic(full_width = F)
dadastat %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive")) 
```

```{r table for sampling depth in qiime, message=FALSE, warning=FALSE, include=FALSE}
depth = read.csv("sampling_depth.csv", sep=",")
depth %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```

## Alpha Diversity Table

```{r echo=FALSE, message=FALSE, warning=FALSE}
obs <- read.table("obs/metadata.tsv", header = TRUE)
shannon <- read.table("shannon/metadata.tsv", header = TRUE)
simpson <- read.table("simpson/metadata.tsv", header=TRUE)
chao1 <- read.table("chao1/metadata.tsv", header=TRUE)
ace <- read.table("ace/metadata.tsv", header=TRUE)
faith_pd <- read.table("faith_pd/metadata.tsv", header=TRUE)

obs <- data.frame(obs[c('id','observed_otus')])
shannon <- data.frame(shannon[c('id','shannon')])
simpson <- data.frame(simpson[c('id','simpson')])
chao1 <- data.frame(chao1[c('id','chao1')])
ace <- data.frame(ace[c("id","ace")])
faith_pd <- data.frame(faith_pd[c("id","faith_pd")])

alpha_summary <- Reduce(function(...) merge(..., by='id', all.x=TRUE), list(obs,shannon,simpson,chao1,ace,faith_pd))
alpha_summary
```

## Alpha Diversity Plot 

### Observed Features 

```{r alpha diversity plot of obs, echo=FALSE, message=FALSE, warning=FALSE}
#subsets and plots observed features in a boxplot format
ioi <- read.csv("item_of_interest.csv")
ioi<-as.character(ioi)
obs_vals = read.csv("./obs/metadata.tsv", sep='\t')
dims = dim(obs_vals)
obs_vals <- data.frame(obs_vals[2:dims[1],])
obs_vals[[ioi]] <- reorder(as.factor(obs_vals[[ioi]]))
obs_vals$observed_otus <- as.numeric(as.character(obs_vals$observed_otus))
obs_boxplot <- ggplot(obs_vals, aes_string(x=ioi,y = obs_vals$observed_otus)) + geom_boxplot() + ylab("Observed Features") +theme_bw()
obs_boxplot 

ggsave("obs_boxplot.png", plot=obs_boxplot, path=outdir)

#plots obs values in a violin plot format 
p <- ggplot(obs_vals, aes(x=obs_vals[[ioi]], y=observed_otus)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Observed Features") + theme_bw()
p

ggsave("obs_violin_plot.png", plot=p, path=outdir)
```


```{r Kruskal-Wallace test for signifiance observed feat, echo=FALSE, message=FALSE, warning=FALSE}
library("ggpubr")
obs <- read.table("obs/metadata.tsv", header = TRUE)
obs_stat <- data.frame(obs[c('id',ioi,'observed_otus')])


form <- as.formula(paste("observed_otus ~ ", ioi))
kruskal_table <- rstatix::kruskal_test(data = obs_stat, formula = form)
kruskal_table

form = as.formula(paste("observed_otus ~", ioi))

dunn_table <- rstatix::dunn_test(data = obs_stat, formula = form, p.adjust.method = "holm") %>% add_xy_position()
dunn_table

p <- ggplot(obs_vals, aes(x=obs_vals[[ioi]], y=observed_otus)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Observed Features") + theme_bw()
p <- p + stat_pvalue_manual(dunn_table, label = "p.adj.signif",hide.ns = TRUE )
p


```

### Shannon

```{r alpha diversity plot of shannon diversity, echo=FALSE, message=FALSE, warning=FALSE}
shannon_vals <- read.table("./shannon/metadata.tsv",sep = '\t', header = TRUE)
dims = dim(shannon_vals)
shannon_vals <- data.frame(shannon_vals[2:dims[1],])
shannon_vals[[ioi]] <- reorder(as.factor(shannon_vals[[ioi]]))
shannon_vals$shannon <- as.numeric(as.character(shannon_vals$shannon))
shannon_boxplot <- ggplot(shannon_vals, aes(x=shannon_vals[[ioi]], y=shannon_vals$shannon)) + geom_boxplot() + ylab("Shannon") + theme_bw() + xlab(ioi)
shannon_boxplot

ggsave("shannon_boxplot.png", plot=shannon_boxplot, path=outdir)

p <- ggplot(shannon_vals, aes(x=shannon_vals[[ioi]], y=shannon)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Shannon") + theme_bw()
p

ggsave("shannon_violin_plot.png", plot=p, path=outdir)
```

```{r Kuskal-Wallace test for significance shannon, echo=FALSE, message=FALSE, warning=FALSE}
shannon <- read.table("shannon/metadata.tsv", header = TRUE, sep='\t')
shannon_stat <- data.frame(shannon[c('id',ioi,'shannon')])

form <- as.formula(paste("shannon ~ ", ioi))
kruskal_table <- rstatix::kruskal_test(data = shannon_stat, formula =form)
kruskal_table

form = as.formula(paste("shannon ~", ioi))

dunn_table <- rstatix::dunn_test(data = shannon_stat, formula = form, p.adjust.method = "holm") %>% add_xy_position()
dunn_table

p <- ggplot(shannon_vals, aes(x=shannon_vals[[ioi]], y=shannon)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Shannon") + theme_bw()
p <- p + stat_pvalue_manual(dunn_table, label = "p.adj.signif",hide.ns = TRUE)
p
```


### Simpson

```{r alpha diversity plot of simpson diversity, echo=FALSE, message=FALSE, warning=FALSE}
simpson_vals <- read.table("./simpson/metadata.tsv",sep = '\t', header = TRUE)
dims = dim(simpson_vals)
simpson_vals <- data.frame(simpson_vals[2:dims[1],])
simpson_vals[[ioi]] <- reorder(as.factor(simpson_vals[[ioi]]))
simpson_vals$simpson <- as.numeric(as.character(simpson_vals$simpson))
simpson_boxplot <- ggplot(simpson_vals, aes(x=simpson_vals[[ioi]], y=simpson_vals$simpson)) + geom_boxplot() + ylab("Simpson") + theme_bw() + xlab(ioi)
simpson_boxplot

ggsave("simpson_boxplot.png", plot=simpson_boxplot, path=outdir)

p <- ggplot(simpson_vals, aes(x=simpson_vals[[ioi]], y=simpson)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Simpson") + theme_bw()
p

ggsave("simpson_violin_plot.png", plot=p, path=outdir)
```

```{r Kuskal-Wallace test for significance simpson, echo=FALSE, message=FALSE, warning=FALSE}
simpson <- read.table("simpson/metadata.tsv", header = TRUE, sep='\t')
simpson_stat <- data.frame(simpson[c('id',ioi,'simpson')])

form <- as.formula(paste("simpson ~ ", ioi))
kruskal_table <- rstatix::kruskal_test(data = simpson_stat, formula = form)
kruskal_table

form = as.formula(paste("simpson ~", ioi))

dunn_table <- rstatix::dunn_test(data = simpson_stat, formula = form, p.adjust.method = "holm") %>% add_xy_position()
dunn_table

p <- ggplot(simpson_vals, aes(x=simpson_vals[[ioi]], y=simpson)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Simpson") + theme_bw()
p <- p+ stat_pvalue_manual(dunn_table, label = "p.adj.signif", hide.ns = TRUE)
p
```

### Chao 1

```{r alpha diversity plot of Chao 1 diversity, echo=FALSE, message=FALSE, warning=FALSE}
chao1_vals <- read.table("./chao1/metadata.tsv",sep = '\t', header = TRUE)
dims = dim(chao1_vals)
chao1_vals <- data.frame(chao1_vals[2:dims[1],])
chao1_vals[[ioi]] <- reorder(as.factor(chao1_vals[[ioi]]))
chao1_vals$chao1 <- as.numeric(as.character(chao1_vals$chao1))
chao1_boxplot <- ggplot(chao1_vals, aes(x=chao1_vals[[ioi]], y=chao1_vals$chao1)) + geom_boxplot() + ylab("Chao 1") + theme_bw() + xlab(ioi)
chao1_boxplot

ggsave("chao1_boxplot.png", plot=chao1_boxplot, path=outdir)

p <- ggplot(chao1_vals, aes(x=chao1_vals[[ioi]], y=chao1)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Chao 1") + theme_bw()
p

ggsave("chao1_violin_plot.png", plot=p, path=outdir)
```

```{r Kuskal-Wallace test for significance chao1, echo=FALSE, message=FALSE, warning=FALSE}
chao1 <- read.table("chao1/metadata.tsv", header = TRUE, sep='\t')
chao1_stat <- data.frame(chao1[c('id',ioi,'chao1')])

form <- as.formula(paste("chao1 ~ ", ioi))
kruskal_table <- rstatix::kruskal_test(data = chao1_stat , formula = form)
kruskal_table

form = as.formula(paste("chao1 ~", ioi))

dunn_table <- rstatix::dunn_test(data = chao1_stat, formula = form, p.adjust.method = "holm") %>% add_xy_position()
dunn_table

p <- ggplot(chao1_vals, aes(x=chao1_vals[[ioi]], y=chao1)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Chao 1") + theme_bw()
p <- p+stat_pvalue_manual(dunn_table, label="p.adj.signif", hide.ns = TRUE)
p
```


### ACE

```{r alpha diversity plot of ACE diversity, echo=FALSE, message=FALSE, warning=FALSE}
ace_vals <- read.table("./ace/metadata.tsv",sep = '\t', header = TRUE)
dims = dim(ace_vals)
ace_vals <- data.frame(ace_vals[2:dims[1],])
ace_vals[[ioi]] <- reorder(as.factor(ace_vals[[ioi]]))
ace_vals$ace <- as.numeric(as.character(ace_vals$ace))
ace_boxplot <- ggplot(ace_vals, aes(x=ace_vals[[ioi]], y=ace_vals$ace)) + geom_boxplot() + ylab("ACE") + theme_bw() + xlab(ioi)
ace_boxplot

ggsave("ace_boxplot.png", plot=ace_boxplot, path=outdir)

p <- ggplot(ace_vals, aes(x=ace_vals[[ioi]], y=ace)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("ACE") + theme_bw()
p

ggsave("ace_violin_plot.png", plot=p, path=outdir)
```

```{r Kuskal-Wallace test for significance ace, echo=FALSE, message=FALSE, warning=FALSE}
ace <- read.table("ace/metadata.tsv", header = TRUE, sep='\t')
ace_stat <- data.frame(ace[c('id',ioi,'ace')])

form <- as.formula(paste("ace ~ ", ioi))
kruskal_table <- rstatix::kruskal_test(data = ace_stat, formula = form)
kruskal_table

form = as.formula(paste("ace ~", ioi))

dunn_table <- rstatix::dunn_test(data = ace_stat, formula = form, p.adjust.method = "holm") %>% add_xy_position()
dunn_table

p <- ggplot(ace_vals, aes(x=ace_vals[[ioi]], y=ace)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("ACE") + theme_bw()
p <- p+ stat_pvalue_manual(dunn_table, label = "p.adj.signif", hide.ns = TRUE)
p
```


### Phylogenetic Distance Over The whole Tree

```{r alpha diversity plot of PD_whole_tree, echo=FALSE, message=FALSE, warning=FALSE}
faith_pd_vals <- read.table("./faith_pd/metadata.tsv",sep = '\t', header = TRUE)
dims = dim(faith_pd_vals)
faith_pd_vals <- data.frame(faith_pd_vals[2:dims[1],])
faith_pd_vals[[ioi]] <- reorder(as.factor(faith_pd_vals[[ioi]]))
faith_pd_vals$faith_pd <- as.numeric(as.character(faith_pd_vals$faith_pd))
faith_pd_boxplot <- ggplot(faith_pd_vals, aes(x=faith_pd_vals[[ioi]], y=faith_pd_vals$faith_pd)) + geom_boxplot() + ylab("Faith PD") + theme_bw() + xlab(ioi)
faith_pd_boxplot

ggsave("faith_pd_boxplot.png", plot=faith_pd_boxplot, path=outdir)

p <- ggplot(faith_pd_vals, aes(x=faith_pd_vals[[ioi]], y=faith_pd)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Faith PD") + theme_bw()
p

ggsave("faith_pd_violin_plot.png", plot=p, path=outdir)
```

```{r Kuskal-Wallace test for significance faith pd, echo=FALSE, message=FALSE, warning=FALSE}
faith_pd <- read.table("faith_pd/metadata.tsv", header = TRUE, sep='\t')
faith_pd_stat <- data.frame(faith_pd[c('id',ioi,'faith_pd')])

form <- as.formula(paste("faith_pd ~ ", ioi))
kruskal_table <- rstatix::kruskal_test(data = faith_pd_stat, formula = form)
kruskal_table

form = as.formula(paste("faith_pd ~", ioi))

dunn_table <- rstatix::dunn_test(data = faith_pd_stat, formula = form, p.adjust.method = "holm") %>% add_xy_position()
dunn_table

p <- ggplot(faith_pd_vals, aes(x=faith_pd_vals[[ioi]], y=faith_pd)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2)) + xlab(ioi) + ylab("Faith PD") + theme_bw()
p <- p+stat_pvalue_manual(dunn_table, label="p.adj.signif", hide.ns = TRUE)
p
```

## Beta diversity 

### Bray curtis ordination

```{r beta diversity plot of bray curtis measurement, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
bray_pcoa <- read_qza("core-metrics-results/bray_curtis_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


bray_curtis <- bray_pcoa$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

bray_curtis
ggsave("bray_curtis_pcoa_ordination.png", plot=bray_curtis, path=outdir)

```

### Jaccard ordination

```{r pcoa using Jaccard distance, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
jaccard <- read_qza("core-metrics-results/jaccard_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")

metadata[[ioi]] <- reorder(metadata[[ioi]])

jaccard_pcoa <- jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

jaccard_pcoa

ggsave("jaccard_pcoa_ordination.png", plot=jaccard_pcoa, path=outdir)
```

### Unweighted unifrac ordination

```{r unweighted unifrac pcoa ordination, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/unweighted_unifrac_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


unweight_unifrac_pcoa <- jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

unweight_unifrac_pcoa 

ggsave("unweighted_unifrac_pcoa_ordination.png", plot=unweight_unifrac_pcoa, path=outdir)

```

### Weighted unifrac ordination

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/weighted_unifrac_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


weighted_unifrac_pcoa <- jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

weighted_unifrac_pcoa

ggsave("weighted_unifrac_pcoa_ordination.png", plot=weighted_unifrac_pcoa, path=outdir)

```

## Rarefaction Curves

```{r rarefaction curves, echo=FALSE, fig.height=10, fig.width=16, message=FALSE, warning=FALSE}


numextract <- function(string){
  str_extract(string, "\\-*\\d+\\.*\\d*")
}

obs_rarefy <- read.csv("alpha-rareplot/observed_otus.csv")
samples <- obs_rarefy[1]
one <- obs_rarefy[2:11]
two <- obs_rarefy[12:21]
three <- obs_rarefy[22:31]
four <- obs_rarefy[32:41]
five <- obs_rarefy[42:51]
six <- obs_rarefy[52:61]
seven <- obs_rarefy[62:71]
eight <- obs_rarefy[72:81]
nine <- obs_rarefy[82:91]
ten <- obs_rarefy[92:101]
obs_item_of_interest <- obs_rarefy[[ioi]]



one_d <- numextract(colnames(obs_rarefy[2:11])[1])
two_d <- numextract(colnames(obs_rarefy[12:21])[1])
three_d <- numextract(colnames(obs_rarefy[22:31])[1])
four_d <- numextract(colnames(obs_rarefy[32:41])[1])
five_d <- numextract(colnames(obs_rarefy[42:51])[1])
six_d <- numextract(colnames(obs_rarefy[52:61])[1])
seven_d <- numextract(colnames(obs_rarefy[62:71])[1])
eight_d <- numextract(colnames(obs_rarefy[72:81])[1])
nine_d <- numextract(colnames(obs_rarefy[82:91])[1])
ten_d <- numextract(colnames(obs_rarefy[92:101])[1])


one["sample"] <- samples
one_flat <- melt(one) %>%
  rename(depth = variable)
one_flat["depth"] <- rep(one_d, dim(one_flat)[1])

one_flat_mean <- one_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

one_flat_mean["depth"] <- rep(one_d, dim(one_flat_mean)[1])

two["sample"] <- samples
two_flat <- melt(two) %>%
  rename(depth = variable)
two_flat["depth"] <- rep(two_d, dim(two_flat)[1])

two_flat_mean <- two_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

two_flat_mean["depth"] <- rep(two_d, dim(two_flat_mean)[1])

three["sample"] <- samples
three_flat <- melt(three) %>% 
  rename(depth = variable)
three_flat["depth"] <- rep(three_d, dim(three_flat)[1])

three_flat_mean <- three_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

three_flat_mean["depth"] <- rep(three_d, dim(three_flat_mean)[1])

four["sample"] <- samples
four_flat <- melt(four) %>%
  rename(depth = variable)
four_flat["depth"] <- rep(four_d, dim(four_flat)[1])

four_flat_mean <- four_flat %>%
  group_by(sample) %>% 
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

four_flat_mean["depth"] <- rep(four_d, dim(four_flat_mean)[1])

five["sample"] <- samples
five_flat <- melt(five) %>%
  rename(depth=variable)
five_flat["depth"] <- rep(five_d, dim(five_flat)[1])

five_flat_mean <- five_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

five_flat_mean["depth"] <- rep(five_d, dim(five_flat_mean)[1])

six["sample"]<-samples
six_flat <- melt(six)%>%
  rename(depth=variable)
six_flat["depth"]<- rep(six_d, dim(six_flat)[1])

six_flat_mean <- six_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

six_flat_mean["depth"] <- rep(six_d, dim(six_flat_mean)[1])

seven["sample"] <- samples
seven_flat <- melt(seven) %>%
  rename(depth=variable)
seven_flat["depth"]<-rep(seven_d, dim(seven_flat)[1])

seven_flat_mean <- seven_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

seven_flat_mean["depth"] <- rep(seven_d, dim(seven_flat_mean)[1])

eight["sample"] <- samples
eight_flat <- melt(eight) %>%
  rename(depth=variable)
eight_flat["depth"] <- rep(eight_d, dim(eight_flat)[1])

eight_flat_mean <- eight_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

eight_flat_mean["depth"] <- rep(eight_d, dim(eight_flat_mean)[1])

nine["sample"] <- samples
nine_flat <- melt(nine) %>%
  rename(depth=variable)
nine_flat["depth"] <- rep(nine_d, dim(nine_flat)[1])

nine_flat_mean <- nine_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

nine_flat_mean["depth"] <- rep(nine_d, dim(nine_flat_mean)[1])

ten["sample"] <- samples
ten_flat <- melt(ten) %>%
  rename(depth=variable)
ten_flat["depth"] <- rep(ten_d, dim(ten_flat)[1])

ten_flat_mean <- ten_flat %>%
  group_by(sample) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

ten_flat_mean["depth"] <- rep(ten_d, dim(ten_flat_mean)[1])


bound <- rbind(one_flat,two_flat, three_flat, four_flat, five_flat, six_flat, seven_flat, eight_flat, nine_flat, ten_flat)
bound_mean <- rbind(one_flat_mean, two_flat_mean, three_flat_mean, four_flat_mean, five_flat_mean, six_flat_mean, seven_flat_mean, eight_flat_mean, nine_flat_mean, ten_flat_mean)



bound$depth <- as.numeric(as.character(bound$depth))

bound <- bound[order(bound$depth),]

rarefy_curve_by_sample <- ggplot(bound, aes(x=depth, y=value, fill=sample, color=sample))+
  geom_point(data=bound_mean, mapping=aes(x=as.numeric(depth), y=as.numeric(average)),size=3) + 
  geom_line(data=bound_mean, mapping= aes(x=as.numeric(depth), y=as.numeric(average), group=sample), size=1) + 
  scale_x_binned("Sampling Depth",n.breaks = 12, nice.breaks = TRUE) + theme_bw() +
  scale_y_continuous("Observed Species") + 
  theme(text=element_text(size = 20))
rarefy_curve_by_sample

ggsave("rarefaction_curve_by_sample.png", plot=rarefy_curve_by_sample, path=outdir)

samples <- obs_rarefy[1]
one <- obs_rarefy[2:11]
two <- obs_rarefy[12:21]
three <- obs_rarefy[22:31]
four <- obs_rarefy[32:41]
five <- obs_rarefy[42:51]
six <- obs_rarefy[52:61]
seven <- obs_rarefy[62:71]
eight <- obs_rarefy[72:81]
nine <- obs_rarefy[82:91]
ten <- obs_rarefy[92:101]
obs_item_of_interest <- obs_rarefy[[ioi]]



one_d <- numextract(colnames(obs_rarefy[2:11])[1])
two_d <- numextract(colnames(obs_rarefy[12:21])[1])
three_d <- numextract(colnames(obs_rarefy[22:31])[1])
four_d <- numextract(colnames(obs_rarefy[32:41])[1])
five_d <- numextract(colnames(obs_rarefy[42:51])[1])
six_d <- numextract(colnames(obs_rarefy[52:61])[1])
seven_d <- numextract(colnames(obs_rarefy[62:71])[1])
eight_d <- numextract(colnames(obs_rarefy[72:81])[1])
nine_d <- numextract(colnames(obs_rarefy[82:91])[1])
ten_d <- numextract(colnames(obs_rarefy[92:101])[1])

fct_ioi <- as.factor(obs_item_of_interest)
one <- cbind(one,fct_ioi)
one_flat <- melt(one,id.vars = "fct_ioi") %>%
  rename(depth = variable) %>%
  rename(ioi = fct_ioi)
one_flat["depth"] <- rep(one_d, dim(one_flat)[1])

one_flat_mean <- one_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

one_flat_mean["depth"] <- rep(one_d, dim(one_flat_mean)[1])

two <- cbind(two, fct_ioi)
two_flat <- melt(two, id.vars = "fct_ioi") %>%
  rename(depth = variable) %>%
  rename(ioi = fct_ioi)
two_flat["depth"] <- rep(two_d, dim(two_flat)[1])

two_flat_mean <- two_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

two_flat_mean["depth"] <- rep(two_d, dim(two_flat_mean)[1])

three <- cbind(three, fct_ioi)
three_flat <- melt(three, id.vars = "fct_ioi") %>% 
  rename(depth = variable) %>%
  rename(ioi = fct_ioi)
three_flat["depth"] <- rep(three_d, dim(three_flat)[1])

three_flat_mean <- three_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

three_flat_mean["depth"] <- rep(three_d, dim(three_flat_mean)[1])

four<- cbind(four, fct_ioi)
four_flat <- melt(four, id.vars = "fct_ioi") %>%
  rename(depth = variable) %>%
  rename(ioi = fct_ioi)
four_flat["depth"] <- rep(four_d, dim(four_flat)[1])

four_flat_mean <- four_flat %>%
  group_by(ioi) %>% 
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

four_flat_mean["depth"] <- rep(four_d, dim(four_flat_mean)[1])

five <- cbind(five, fct_ioi)
five_flat <- melt(five, id.vars = "fct_ioi") %>%
  rename(depth=variable) %>%
  rename(ioi= fct_ioi)
five_flat["depth"] <- rep(five_d, dim(five_flat)[1])

five_flat_mean <- five_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

five_flat_mean["depth"] <- rep(five_d, dim(five_flat_mean)[1])

six<-cbind(six, fct_ioi)
six_flat <- melt(six, id.vars = "fct_ioi")%>%
  rename(depth=variable) %>%
  rename(ioi = fct_ioi)
six_flat["depth"]<- rep(six_d, dim(six_flat)[1])

six_flat_mean <- six_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

six_flat_mean["depth"] <- rep(six_d, dim(six_flat_mean)[1])

seven<- cbind(seven, fct_ioi)
seven_flat <- melt(seven,id.vars = "fct_ioi") %>%
  rename(depth=variable) %>%
  rename(ioi = fct_ioi)
seven_flat["depth"]<-rep(seven_d, dim(seven_flat)[1])

seven_flat_mean <- seven_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

seven_flat_mean["depth"] <- rep(seven_d, dim(seven_flat_mean)[1])

eight<- cbind(eight, fct_ioi)
eight_flat <- melt(eight,id.vars = "fct_ioi") %>%
  rename(depth=variable) %>%
  rename(ioi = fct_ioi)
eight_flat["depth"] <- rep(eight_d, dim(eight_flat)[1])

eight_flat_mean <- eight_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

eight_flat_mean["depth"] <- rep(eight_d, dim(eight_flat_mean)[1])

nine <- cbind(nine, fct_ioi)
nine_flat <- melt(nine,id.vars = "fct_ioi") %>%
  rename(depth=variable) %>%
  rename(ioi = fct_ioi)
nine_flat["depth"] <- rep(nine_d, dim(nine_flat)[1])

nine_flat_mean <- nine_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

nine_flat_mean["depth"] <- rep(nine_d, dim(nine_flat_mean)[1])

ten <- cbind(ten,fct_ioi)
ten_flat <- melt(ten, id.vars = "fct_ioi") %>%
  rename(depth=variable) %>%
  rename(ioi = fct_ioi)
ten_flat["depth"] <- rep(ten_d, dim(ten_flat)[1])

ten_flat_mean <- ten_flat %>%
  group_by(ioi) %>%
  summarise(average=mean(value,na.rm = TRUE)) %>%
  ungroup()

ten_flat_mean["depth"] <- rep(ten_d, dim(ten_flat_mean)[1])


bound <- rbind(one_flat,two_flat, three_flat, four_flat, five_flat, six_flat, seven_flat, eight_flat, nine_flat, ten_flat)
bound_mean <- rbind(one_flat_mean, two_flat_mean, three_flat_mean, four_flat_mean, five_flat_mean, six_flat_mean, seven_flat_mean, eight_flat_mean, nine_flat_mean, ten_flat_mean)

bound$depth <- as.numeric(as.character(bound$depth))

bound <- bound[order(bound$depth),]


rarefy_curve_by_treatment <- ggplot(bound, aes(x=depth, y=value, color=fct_relevel(fct_reorder(ioi, as.numeric(ioi)))))+
  geom_point(data=bound_mean, mapping=aes(x=as.numeric(depth), y=as.numeric(average)),size=3) + 
  geom_line(data=bound_mean, mapping= aes(x=as.numeric(depth), y=as.numeric(average), group=ioi), size=1) + 
  scale_x_binned("Sampling Depth",n.breaks = 12, nice.breaks = TRUE) + theme_bw() +
  scale_y_continuous("Observed Species") + 
  theme(text=element_text(size = 20)) + 
  scale_color_discrete(name = ioi)

rarefy_curve_by_treatment
ggsave("rarefaction_curve_by_treatment.png", plot=rarefy_curve_by_treatment, path=outdir)
```

## Ranked Abundance Curves
```{r, echo=FALSE, fig.height=10, fig.width=16, message=FALSE, warning=FALSE}
library(ampvis2)
library(ggplot2)
devtools::source_gist("8d0ca4206a66be7ff6d76fc4ab8e66c6")

cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv") 
cycle_1_amp <- phyloseq_to_ampvis2(cycle_1)

by_sample <- ampvis2::amp_rankabundance(cycle_1_amp, group_by = "SampleID") + theme(text=element_text(size = 20))
by_sample 
ggsave("rank_abundance_curve_by_treatment.png", plot=by_sample, path=outdir)

cycle_1_amp$metadata[[ioi]] <- reorder(cycle_1_amp$metadata[[ioi]])

by_group <- ampvis2::amp_rankabundance(cycle_1_amp, group_by = ioi) + theme(text=element_text(size = 20))
by_group
ggsave("rank_abundance_curve_by_treatment.png", plot=by_group, path=outdir)




heatmap <- ampvis2::amp_heatmap(cycle_1_amp,
                     group_by = "SampleID", 
                     tax_aggregate = "Genus",
                     tax_show = 30,
                     facet_by = ioi,
                     tax_add = "Phylum",
                     plot_values = FALSE,
                     plot_colorscale = "log10") +
  theme(text=element_text(size = 20))

heatmap
ggsave("heatmap.png", plot=heatmap, path=outdir)

```


## Unifrac Heatmap 


```{r echo=FALSE,fig.height=10, fig.width=18, message=FALSE, warning=FALSE}
metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
w_unifrac_dist <- read_qza("core-metrics-results/weighted_unifrac_distance_matrix.qza")
u_unifrac_dist <- read_qza("core-metrics-results/unweighted_unifrac_distance_matrix.qza")

un_weight_matrix <- as.matrix(u_unifrac_dist$data)
un_weight_matrix[lower.tri(un_weight_matrix)] <- NA
un_weight_heatmap <- pheatmap(un_weight_matrix, cluster_rows = F, cluster_cols = F, na_col = "grey", display_numbers = T, number_format ="%.3f",main = "Beta Diversity Heatmap using Unweighted Unifrac Distance", fontsize = 15)
un_weight_heatmap

ggsave("beta_div_heatmap_unweight_unifrac.png", plot=un_weight_heatmap, path=outdir)

weight_matrix <- as.matrix(w_unifrac_dist$data)
weight_matrix[lower.tri(weight_matrix)] <- NA
weight_heatmap <- pheatmap(weight_matrix, cluster_rows = F, cluster_cols = F, na_col = "grey", display_numbers = T, number_format ="%.3f",main = "Beta Diversity Heatmap using Weighted Unifrac Distance", fontsize = 15)
weight_heatmap

ggsave("beta_div_heatmap_Weighted_unifrac.png", plot=weight_heatmap, path=outdir)
```




