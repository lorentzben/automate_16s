---
title: "Analysis Report"
output: html_notebook
---
```{r include=FALSE}
if(!require(kableExtra)) {install.packages("kableExtra", repos="http://cran.us.r-project.org")}
if(!require(ggplot2)) {install.packages("ggplot2", repos="http://cran.us.r-project.org")}
if(!require(tidyverse)) {install.packages("tidyverse", repos="http://cran.us.r-project.org")}
if(!require(gplots)) {install.packages("gplots", repos="http://cran.us.r-project.org")}
if (!requireNamespace("devtools", quietly = TRUE)){install.packages("devtools")}
if(!require(qiime2R)) {devtools::install_github("jbisanz/qiime2R")} # current version is 0.99.20
if(!require(phyloseq)) {install.packages("phyloseq")}
if(!require(gtools)) {install.packages("gtools")}
if(!require(reshape2)) {install.packages("reshape2")}
if(!require(forcats)) {install.packages("forcats")}
library(gtools)
library(kableExtra)
library(ggplot2)
library(qiime2R)
library(phyloseq)
library(reshape2)
library(forcats)
```
This is a report generated to summarize the major results from the analysis. It is not intended to be a full picture, rather a jumping off point. This report will reference the files displayed in case you would like to examine them further.


```{r include=FALSE}
ioi <- read.csv("item_of_interest.csv")
ioi<-as.character(ioi)
```

## Species Distribution

### Relative Abundance of Top 10 taxa At Phylum Level 

```{r echo=FALSE, message=FALSE, warning=FALSE}
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

cycle_1_glom <- tax_glom(cycle_1, taxrank = "Phylum")

topN <- 10
most_abundant_taxa <- sort(taxa_sums(cycle_1_glom), TRUE)[1:topN]

cycle_10 <- prune_taxa(names(most_abundant_taxa), cycle_1_glom)

cycle_1_phylum <- cycle_10 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance > 0.02) %>%
  arrange(Abundance)

cycle_1_other <- cycle_10 %>%
  tax_glom(taxrank = "Phylum") %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance < 0.02) %>%
  arrange(Abundance)

other <- aggregate(cycle_1_other$Abundance, by=list(Category=cycle_1_other$Sample), FUN=sum)
other <- cbind(other, rep("Other", dim(other)[1]))
colnames(other) <- c("Sample","Abundance","Phylum")

cycle_1_phylum <- cycle_1_phylum %>% 
  add_row(other) %>%
  arrange(Abundance)


ggplot(cycle_1_phylum, aes(x=Sample, y=Abundance, fill=fct_reorder(Phylum, Abundance))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title="Phylum"))


cy_phylum <- cycle_10 %>%
  tax_glom(taxrank = "Phylum") %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance > 0.02) %>%
  arrange(Abundance)

cy_1_other <- cycle_10 %>%
  tax_glom(taxrank = "Phylum") %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance < 0.02) %>%
  arrange(Abundance)


other <- aggregate(cy_1_other$Abundance, by=list(Category=cy_1_other$Sample), FUN=sum)
other <- cbind(other, rep("Other", dim(other)[1]))
colnames(other) <- c("Sample","Abundance","Phylum")

cy_phylum <- cy_phylum %>% 
  add_row(other) %>%
  arrange(Abundance)


ggplot(cy_phylum, aes(x=Sample, y=Abundance, fill=fct_reorder(Phylum,Abundance))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title="Phylum")) + 
  xlab(label = ioi)

```
### Relative Abundance of Top 10 taxa At Genus Level 

```{r echo=FALSE, message=FALSE, warning=FALSE}
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

cycle_1_glom <- tax_glom(cycle_1, taxrank = "Genus")

topN <- 10
most_abundant_taxa <- sort(taxa_sums(cycle_1_glom), TRUE)[1:topN]

cycle_10 <- prune_taxa(names(most_abundant_taxa), cycle_1_glom)


cycle_1_genus <- cycle_10 %>%
  tax_glom(taxrank = "Genus") %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance > 0.02) %>%
  arrange(Abundance)

cycle_1_other <- cycle_10 %>%
  tax_glom(taxrank = "Genus") %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance < 0.02) %>%
  arrange(Abundance)

other <- aggregate(cycle_1_other$Abundance, by=list(Category=cycle_1_other$Sample), FUN=sum)
other <- cbind(other, rep("Other", dim(other)[1]))
colnames(other) <- c("Sample","Abundance","Genus")

cycle_1_genus <- cycle_1_genus %>% 
  add_row(other) %>%
  arrange(Abundance)


ggplot(cycle_1_genus, aes(x=Sample, y=Abundance, fill=fct_reorder(Genus, Abundance))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title="Genus"))




cy_genus <- cycle_10 %>%
  tax_glom(taxrank = "Genus") %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance > 0.02)
  arrange(Abundance)

cy_1_other <- cycle_10 %>%
  tax_glom(taxrank = "Genus") %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance < 0.02) %>%
  arrange(Abundance)

other <- aggregate(cy_1_other$Abundance, by=list(Category=cy_1_other$Sample), FUN=sum)
other <- cbind(other, rep("Other", dim(other)[1]))
colnames(other) <- c("Sample","Abundance","Genus")

cy_genus <- cy_genus %>% 
  add_row(other) %>%
  arrange(Abundance)




ggplot(cy_genus, aes(x=Sample, y=Abundance, fill=fct_reorder(Genus,Abundance))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title="Genus")) + 
  xlab(label = ioi)

```

### Relative Abundance At Species Level 

```{r echo=FALSE, message=FALSE, warning=FALSE}
cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

cycle_1_glom <- tax_glom(cycle_1, taxrank = "Species")

topN <- 10
most_abundant_taxa <- sort(taxa_sums(cycle_1_glom), TRUE)[1:topN]

cycle_10 <- prune_taxa(names(most_abundant_taxa), cycle_1_glom)

cycle_1_species <- cycle_10 %>%
  tax_glom(taxrank = "Species") %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance > 0.02) %>%
  arrange(Abundance)

cycle_1_other <- cycle_10 %>%
  tax_glom(taxrank = "Species") %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance < 0.02) %>%
  arrange(Abundance)

other <- aggregate(cycle_1_other$Abundance, by=list(Category=cycle_1_other$Sample), FUN=sum)
other <- cbind(other, rep("Other", dim(other)[1]))
colnames(other) <- c("Sample","Abundance","Species")

cycle_1_species <- cycle_1_species %>% 
  add_row(other) %>%
  arrange(Abundance)


ggplot(cycle_1_species, aes(x=Sample, y=Abundance, fill=fct_reorder(Species, Abundance))) + 
  geom_bar(stat= "identity") +
  xlab("Sample ID") +
  guides(fill=guide_legend(title="Species"))




cy_species <- cycle_10 %>%
  tax_glom(taxrank = "Species") %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance > 0.02) %>%
  arrange(Abundance)

cy_1_other <- cycle_10 %>%
  tax_glom(taxrank = "Species") %>%
  merge_samples(ioi,fun=sum) %>%
  transform_sample_counts(function(x) {x/sum(x)}) %>%
  psmelt() %>%
  filter(Abundance < 0.02) %>%
  arrange(Abundance)

other <- aggregate(cy_1_other$Abundance, by=list(Category=cy_1_other$Sample), FUN=sum)
other <- cbind(other, rep("Other", dim(other)[1]))
colnames(other) <- c("Sample","Abundance","Species")

cy_species <- cy_species %>% 
  add_row(other) %>%
  arrange(Abundance)





ggplot(cy_species, aes(x=Sample, y=Abundance, fill=fct_reorder(Species,Abundance))) + 
  geom_bar(stat="identity") +
  guides(fill=guide_legend(title="Species")) + 
  xlab(label = ioi)

```

```{r}
data("GlobalPatterns")
gpt <- subset_taxa(GlobalPatterns, Kingdom=="Bacteria")
gpt <- prune_taxa(names(sort(taxa_sums(gpt),TRUE)[1:300]), gpt)
plot_heatmap(gpt, sample.label="SampleType")
heatmap(otu_table(cycle_1), scale="row")
```


```{r include=FALSE}
cutoffs = read.csv("cutoffs.csv",sep = ',',strip.white = TRUE)
#cutoffs = knitr::kable(cutoffs)
cutoffs %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```


```{r include=FALSE}
dadastat = read.csv("dada2_stats.tsv",sep = '\t',strip.white = TRUE)
#dadastat_t = dadastat %>% kbl() %>% kable_classic(full_width = F)
dadastat %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive")) 
```

```{r include=FALSE}
depth = read.csv("sampling_depth.csv", sep=",")
depth %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```


```{r include=FALSE}
evenness_vals = read.csv("./evenness/metadata.tsv", sep='\t')
evenness_vals %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```

```{r include=FALSE}

filename = paste("./evenness/kruskal-wallis-pairwise-",str_trim(ioi),".csv", sep = "")
evenness_stats = read.csv(filename)

evenness_stats %>% kbl() %>% kable_styling(bootstrap_options = c("condensed","responsive"))
```


```{r include=FALSE}
faith_vals = read.csv("./faith/metadata.tsv", sep='\t')
faith_vals %>% kbl() %>% kable_styling(bootstrap_options = c("striped","condensed","responsive"))
```
```{r include=FALSE}
filename <- paste("./faith/kruskal-wallis-pairwise-",ioi,".csv",sep="")
faith_stats = read.csv(filename)
faith_stats %>% kbl() %>% kable_styling(bootstrap_options = c("condensed","responsive"))
```


```{r include=FALSE}
library(qiime2R)
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon$data
```

```{r include=FALSE}
library(qiime2R)
obs<-read_qza("core-metrics-results/observed_features_vector.qza")
obs$data
```
## Alpha Diversity Plot 

###Evenness 

```{r echo=FALSE, message=FALSE, warning=FALSE}
dims = dim(evenness_vals)
evenness_vals <- data.frame(evenness_vals[2:dims[1],])
evenness_vals[[ioi]] <- reorder(as.factor(evenness_vals[[ioi]]))
evenness_vals$pielou_evenness <- as.numeric(as.character(evenness_vals$pielou_evenness))
boxplot(evenness_vals$pielou_evenness~evenness_vals[[ioi]], data=evenness_vals, xlab = ioi)


p <- ggplot(evenness_vals, aes(x=evenness_vals[[ioi]], y=pielou_evenness)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2))
p
```

###Faith

```{r echo=FALSE,message=FALSE, warning=FALSE}
dims = dim(faith_vals)
faith_vals <- data.frame(faith_vals[2:dims[1],])
faith_vals[[ioi]] <- reorder(as.factor(faith_vals[[ioi]]))
faith_vals$faith_pd <- as.numeric(as.character(faith_vals$faith_pd))
boxplot(faith_vals$faith_pd~faith_vals[[ioi]], data=faith_vals)

p <- ggplot(faith_vals, aes(x=faith_vals[[ioi]], y=faith_pd)) + geom_violin()+ geom_boxplot(width=0.1)
p<- p + stat_summary(fun.y=mean, geom="point", shape=23, size=2)
p<-p + stat_summary(fun.y=median, geom="point", size=2, color="red")
p <- p+geom_jitter(shape=16, position=position_jitter(0.2))
p
```
## Beta diversity 


###Bray curtis ordination

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/bray_curtis_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

```

###Jaccard ordination

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
jaccard <- read_qza("core-metrics-results/jaccard_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")

metadata[[ioi]] <- reorder(metadata[[ioi]])

jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

```

###unweighted unifrac ordination

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/unweighted_unifrac_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

```

###weighted unifrac ordination

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(qiime2R)
library(gplots)

metadata<-read_q2metadata("metadata.tsv")
metadata[[ioi]] <- reorder(metadata[[ioi]])
jaccard <- read_qza("core-metrics-results/weighted_unifrac_pcoa_results.qza")
shannon<-read_qza("core-metrics-results/shannon_vector.qza")
shannon <- shannon$data %>% rownames_to_column("SampleID")


jaccard$data$Vectors %>%
  select(SampleID, PC1, PC2) %>%
  left_join(metadata) %>%
  left_join(shannon) %>%
  ggplot(aes_string(x="PC1", y="PC2", color=ioi, size="shannon_entropy"))+
  geom_point(alpha=0.5) +
  theme_q2r() +
  scale_size_continuous(name="Shannon Diversity") +
  scale_color_discrete(name=ioi)

```

###OTU Plot

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(qiime2R)
library(phyloseq)
library(gtools)

cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

phy <- plot_bar(cycle_1, x=ioi, fill="Phylum")
phy$data[[ioi]] <- factor(x = phy$data[[ioi]], levels= mixedsort(unique(as.character(phy$data[[ioi]]))))
phy<- phy + ggtitle("OTUs at the Phylum level")
phy 

class <- plot_bar(cycle_1, x=ioi , fill="Class")
class$data[[ioi]] <- factor(x = class$data[[ioi]], levels= mixedsort(unique(as.character(class$data[[ioi]]))))
class <- class + ggtitle("OTUs at the Class level")
class

```

###Top 20 Most abundant OTUs

```{r echo=FALSE,message=FALSE, warning=FALSE}
library(qiime2R)
library(phyloseq)
library(gtools)

cycle_1 <- qza_to_phyloseq("table-dada2.qza","rooted-tree.qza","taxonomy.qza","metadata.tsv")

topN <- 20
most_abundant_taxa <- sort(taxa_sums(cycle_1), TRUE)[1:topN]

cycle_20 <- prune_taxa(names(most_abundant_taxa), cycle_1)

phyglom <- tax_glom(cycle_20, "Phylum")
phy <- plot_bar(phyglom, x=ioi, fill="Phylum")
phy$data[[ioi]] <- factor(x = phy$data[[ioi]], levels= mixedsort(unique(as.character(phy$data[[ioi]]))))
phy<- phy + ggtitle("Top 20 most abundant OTUs at Phylum Level")
phy


classglom <- tax_glom(cycle_20, "Class")
class <- plot_bar(classglom, x=ioi , fill="Class")
class$data[[ioi]] <- factor(x = class$data[[ioi]], levels= mixedsort(unique(as.character(class$data[[ioi]]))))
class <- class + ggtitle("Top 20 most abundant OTUs at Class level")
class

```


